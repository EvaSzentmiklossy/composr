<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2015

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    wiki_sync
 */
/*function init__site__pages__modules_custom__wiki($code)      TODO: This will need to be done in Mx_wiki as we cannot mix code overrides with code rewriting
{
    $code=str_replace(
        ',$merge_url, new Tempcode(), new Tempcode());',
        ',$merge_url, new Tempcode(), new Tempcode(), null, \'\', null, null, null, null, true, true, get_option(\'wiki_enable_wysiwyg\') == \'0\');',
        $code
    );
    $code=str_replace(
        ', null, \'\', $specialisation, $parsed, $javascript);',
        ', null, \'\', $specialisation, $parsed, $javascript, null, true, true, get_option(\'wiki_enable_wysiwyg\') == \'0\');',
        $code
    );
    return $code;
}*/

class Mx_wiki extends Module_wiki
{
    public function run_start()
    {
        i_solemnly_declare(I_UNDERSTAND_SQL_INJECTION | I_UNDERSTAND_XSS | I_UNDERSTAND_PATH_INJECTION);

        return parent::run_start();
    }

    public function changes()
    {
        $url = get_option('wiki_alt_changes_link_stub');
        if ($url == '') {
            return parent::changes();
        }

        $_id = get_param_string('id', null);
        $id = null;
        if (!is_null($_id)) {
            list($id,) = get_param_wiki_chain('id');

            require_code('wiki_sync');

            $page_name = find_filename_for_wiki_page($id);

            if (substr($url, -1) != '/') {
                $url .= '/';
            }
            $url .= $page_name . '.txt';
        }

        return redirect_screen($this->title, $url);
    }
}
