<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    ecommerce
 */

/**
 * Recalculate tax that is due based on customer context.
 *
 * @param  ?array $details Map of product details (null: it's for shipping cost only).
 * @param  REAL $tax The default tax due if liable. This may be different to $details['tax'], e.g. if a discount is in place.
 * @param  REAL $shipping_cost_tax The shipping cost tax.
 * @param  ?MEMBER $member_id The member this is for (null: current member).
 * @param  integer $quantity The quantity of items.
 * @return REAL The tax actually due (either zero or same as $tax, unless you are doing something clever).
 */
function recalculate_tax_due($details, $tax, $shipping_cost_tax = 0.00, $member_id = null, $quantity = 1)
{
    // ADD CUSTOM CODE HERE BY OVERRIDING THIS FUNCTION

    $shipping_email = '';
    $shipping_phone = '';
    $shipping_firstname = '';
    $shipping_lastname = '';
    $shipping_street_address = '';
    $shipping_city = '';
    $shipping_county = '';
    $shipping_state = '';
    $shipping_post_code = '';
    $shipping_country = '';
    get_default_ecommerce_fields($member_id, $shipping_email, $shipping_phone, $shipping_firstname, $shipping_lastname, $shipping_street_address, $shipping_city, $shipping_county, $shipping_state, $shipping_post_code, $shipping_country);

    $tax = get_tax_rate_from_tax_code($tax); // TODO

    return $tax * $quantity + $shipping_cost_tax;
}

/**
 * Get a tax rate from a tax code.
 *
 * @param  string $tax_code The tax code.
 * @return float The tax rate.
 */
function get_tax_rate_from_tax_code($tax_code)
{
    // Europe
    if ($tax_code == 'EU') {
        require_code('files2');
        list($__rates) = cache_and_carry('http_download_file', array('http://euvat.ga/rates.json'));
        $_rates = json_decode($__rates, true); // TODO: Fix in v11

        $shipping_email = '';
        $shipping_phone = '';
        $shipping_firstname = '';
        $shipping_lastname = '';
        $shipping_street_address = '';
        $shipping_city = '';
        $shipping_county = '';
        $shipping_state = '';
        $shipping_post_code = '';
        $shipping_country = '';
        $shipping_email = '';
        $shipping_phone = '';
        $cardholder_name = '';
        $card_type = '';
        $card_number = null;
        $card_start_date_year = null;
        $card_start_date_month = null;
        $card_expiry_date_year = null;
        $card_expiry_date_month = null;
        $card_issue_number = null;
        $card_cv2 = null;
        $billing_street_address = '';
        $billing_city = '';
        $billing_county = '';
        $billing_state = '';
        $billing_post_code = '';
        $billing_country = '';
        get_default_ecommerce_fields(get_member(), $shipping_email, $shipping_phone, $shipping_firstname, $shipping_lastname, $shipping_street_address, $shipping_city, $shipping_county, $shipping_state, $shipping_post_code, $shipping_country, $cardholder_name, $card_type, $card_number, $card_start_date_year, $card_start_date_month, $card_expiry_date_year, $card_expiry_date_month, $card_issue_number, $card_cv2, $billing_street_address, $billing_city, $billing_county, $billing_state, $billing_post_code, $billing_country, true)

        if (isset($_rates['rates'][$shipping_country])) {
            $rate = $_rates['rates'][$shipping_country]['standard_rate'];
        } else {
            $rate = 0.00; // Not in Europe
        }
        return $rate;
    }

    // America
    if (preg_match('#^TIC:#', $tax_code) != 0) {
        if ((get_option('taxcloud_api_key') != '') && (get_option('taxcloud_api_id') != '')) {
            $url = 'https://api.taxcloud.com/1.0/TaxCloud/VerifyAddress';
            $data = array()
                'apiLoginID': get_option('taxcloud_api_id'),
                'apiKey': get_option('taxcloud_api_id'),
                'Address1': get_option('business_street_address'),
                'Address2': '',
                'City': get_option('business_city'),
                'State': get_option('business_state'),
                'Zip5': '06851',
                'Zip4': '',
            );
            $post_params = array('' => json_encode($data);
            http_download_file($url, null, true, false, 'Composr', $post_params, null, null, null, null, null, null, null, 10.0, false, null, null, null, 'application/json'); // TODO: Fix in v11

            // TODO
        } else {
            return 0.00;
        }
    }

    // Simple flat rate, with some guards...

    $php_errormsg = mixed();
    $tax_country_regexp = get_option('tax_country_regexp');
    $check = @preg_match('#' . $tax_country_regexp . '#', $shipping_country);
    if ($check === false) {
        warn_exit(do_lang_tempcode('INVALID_REGULAR_EXPRESSION', do_lang('TAX_COUNTRY_REGEXP'), escape_html($tax_country_regexp), $php_errormsg));
    }
    if ($check == 0) {
        return 0.00;
    }
    $tax_state_regexp = get_option('tax_state_regexp');
    if ($tax_state_regexp !== null) {
        $check = @preg_match('#' . $tax_state_regexp . '#', $shipping_state);
        if ($check === false) {
            warn_exit(do_lang_tempcode('INVALID_REGULAR_EXPRESSION', do_lang('TAX_STATE_REGEXP'), escape_html($tax_country_regexp), $php_errormsg));
        }
        if ($check == 0) {
            return 0.00;
        }
    }

    return float_unformat($tax_code);
}

/**
 * Work out the tax rate for a given flat tax figure.
 *
 * @param  REAL $price Price.
 * @param  REAL $tax Tax.
 * @return REAL The tax rate (as a percentage).
 */
function backcalculate_tax_rate($price, $tax)
{
    if ($price == 0.00) {
        return 0.0;
    }
    return round(100.0 * ($tax / $price), 1);
}

/**
 * Generate an invoicing breakdown.
 *
 * @param  ID_TEXT $type_code The product codename.
 * @param  SHORT_TEXT $item_name The human-readable product title.
 * @param  ID_TEXT $purchase_id The purchase ID.
 * @param  REAL $price Transaction price.
 * @param  REAL $tax Transaction tax.
 * @param  ?REAL $shipping_cost Transaction shipping cost (null: no shipping).
 * @return array Invoicing breakdown.
 */
function generate_invoicing_breakdown($type_code, $item_name, $purchase_id, $price, $tax, $shipping_cost = null)
{
    $invoicing_breakdown = array();

    if (preg_match('#^CART\_ORDER\_\d+$#', $type_code) == 0) {
        $invoicing_breakdown[] = array(
            'type_code' => $type_code,
            'item_name' => $item_name,
            'quantity' => 1,
            'unit_price' => $price,
            'unit_tax' => $tax,
        );
    } else {
        $order_id = intval(substr($type_code, strlen('CART_ORDER_')));

        $total_price = 0.00;
        $total_tax = 0.00;

        $_items = $GLOBALS['SITE_DB']->query_select('shopping_order_details', array('*'), array('p_order_id' => $order_id));
        foreach ($_items as $_item) {
            $invoicing_breakdown[] = array(
                'type_code' => $_item['p_type_code'],
                'item_name' => $_item['p_name'],
                'quantity' => $_item['p_quantity'],
                'unit_price' => $_item['p_price'],
                'unit_tax' => $_item['p_tax'],
            );

            $total_price += $_item['p_price'];
            $total_tax += $_item['p_tax'];
        }

        if ($shipping_cost !== null) {
            $total_price += $shipping_cost;
        }

        if (($total_price != $price) || ($total_tax != $tax)) {
            $invoicing_breakdown[] = array(
                'type_code' => '',
                'item_name' => do_lang('PRICING_ADJUSTMENT'),
                'quantity' => 1,
                'unit_price' => $price - $total_price,
                'unit_tax' => $tax - $total_tax,
            );
        }
    }

    if ($shipping_cost !== null) {
        $invoicing_breakdown[] = array(
            'type_code' => '',
            'item_name' => do_lang('SHIPPING'),
            'quantity' => 1,
            'unit_price' => $shipping_cost,
            'unit_tax' => calculate_shipping_tax($shipping_cost),
        );
    }

    return $invoicing_breakdown;
}

/**
 * Send an invoice notification to a member.
 *
 * @param  MEMBER $member_id The member to send to.
 * @param  AUTO_LINK $id The invoice ID.
 */
function send_invoice_notification($member_id, $id)
{
    // Send out notification
    require_code('notifications');
    $_url = build_url(array('page' => 'invoices', 'type' => 'browse'), get_module_zone('invoices'), null, false, false, true);
    $url = $_url->evaluate();
    $subject = do_lang('INVOICE_SUBJECT', strval($id), null, null, get_lang($member_id));
    $body = do_notification_lang('INVOICE_MESSAGE', $url, get_site_name(), null, get_lang($member_id));
    dispatch_notification('invoice', null, $subject, $body, array($member_id));
}

/**
 * Generate tax invoice.
 *
 * @param  ID_TEXT $txn_id Transaction ID.
 * @return Tempcode Tax invoice.
 */
function generate_tax_invoice($txn_id)
{
    require_css('ecommerce');
    require_code('locations');

    $transaction_row = get_transaction_row($txn_id);

    $address_rows = $GLOBALS['SITE_DB']->query_select('ecom_trans_addresses', array('*'), array('a_trans_expecting_id' => $txn_id), '', 1);
    $trans_address = '';
    if (array_key_exists(0, $address_rows)) {
        $address_row = $address_rows[0];

        $lines = array(
            $address_row['a_firstname'] . ' ' . $address_row['a_lastname'],
            $address_row['a_street_address'],
            $address_row['a_city'],
            $address_row['a_county'],
            $address_row['a_state'],
            $address_row['a_post_code'],
            find_country_name_from_iso($address_row['a_country']),
        );
        foreach ($lines as $line) {
            if (trim($line) != '') {
                $trans_address .= trim($line) . "\n";
            }
        }
        $trans_address = rtrim($trans_address);
    }

    $items = ($transaction_row['t_invoicing_breakdown'] == '') ? array() : json_decode($transaction_row['t_invoicing_breakdown'], true);
    $invoicing_breakdown = array();
    foreach ($items as $item) {
        $invoicing_breakdown[] = array(
            'TYPE_CODE' => $item['type_code'],
            'ITEM_NAME' => $item['item_name'],
            'QUANTITY' => $item['quantity'],
            'UNIT_PRICE' => float_format($item['unit_price']),
            'PRICE' => float_format($item['unit_price'] * $item['quantity']),
            'UNIT_TAX' => float_format($item['unit_tax']),
            'TAX' => float_format($item['unit_tax'] * $item['quantity']),
            'TAX_RATE' => float_format(backcalculate_tax_rate($item['unit_price'], $item['unit_tax']), 1, true),
        );
    }
    if (count($invoicing_breakdown) == 0) { 
        // We don't have a break-down so at least find a single line-item

        list($details) = find_product_details($transaction_row['t_type_code']);
        if ($details !== null) {
            $item_name = $details['item_name'];
        } else {
            $item_name = $transaction_row['t_type_code'];
        }

        $invoicing_breakdown[] = array(
            'TYPE_CODE' => $transaction_row['t_type_code'],
            'ITEM_NAME' => $item_name,
            'QUANTITY' => 1,
            'UNIT_PRICE' => float_format($transaction_row['t_amount']),
            'PRICE' => float_format($transaction_row['t_amount']),
            'UNIT_TAX' => float_format($transaction_row['t_tax']),
            'TAX' => float_format($transaction_row['t_tax']),
            'TAX_RATE' => float_format(backcalculate_tax_rate($transaction_row['t_amount'], $transaction_row['t_tax']), 1, true),
        );
    }

    $status = get_transaction_status_string($transaction_row['t_status']);

    return do_template('ECOM_TAX_INVOICE', array(
        'TXN_ID' => $txn_id,
        '_DATE' => strval($transaction_row['t_time']),
        'DATE' => get_timezoned_date($transaction_row['t_time'], false, false, false, true),
        'TRANS_ADDRESS' => $trans_address,
        'ITEMS' => $invoicing_breakdown,
        'CURRENCY' => $transaction_row['t_currency'],
        'TOTAL_PRICE' => float_format($transaction_row['t_amount']),
        'TOTAL_TAX' => float_format($transaction_row['t_tax']),
        'TOTAL_AMOUNT' => float_format($transaction_row['t_amount'] + $transaction_row['t_tax']),
        'PURCHASE_ID' => $transaction_row['t_purchase_id'],
        'STATUS' => $status,
    ));
}

/**
 * Get the Tempcode for a tax input widget.
 *
 * @param  mixed $set_title A human intelligible name for this input field
 * @param  mixed $description A description for this input field
 * @param  ID_TEXT $set_name The name which this input field is for
 * @param  ?string $default The default value for this input field (null: blank)
 * @param  boolean $required Whether this is a required input field
 * @param  ?integer $tabindex The tab index of the field (null: not specified)
 * @return Tempcode The input field
 */
function form_input_tax($set_title, $description, $set_name, $default, $required, $tabindex = null)
{
    $tabindex = get_form_field_tabindex($tabindex);

    $default = filter_form_field_default($set_name, ($default === null) ? '' : $default);

    $required = filter_form_field_required($set_name, $required);
    $_required = ($required) ? '_required' : '';

    $fields = new Tempcode();
    $field_set = alternate_fields_set__start($set_name);

    // Simple rate input ...

    $input = do_template('FORM_SCREEN_INPUT_FLOAT', array(
        'TABINDEX' => strval($tabindex),
        'REQUIRED' => $_required,
        'NAME' => $set_name . '_float',
        'DEFAULT' => (($default === null) || ($default === '') || (!is_numeric($default[0]))) ? '' : float_format($default, 2, false),
    ));
    $field_set->attach(_form_input($set_name . '_float', do_lang_tempcode('TAX_RATE'), do_lang_tempcode('DESCRIPTION_TAX_RATE'), $input, $required, false, $tabindex));

    // EU rate input...

    $input = do_template('FORM_SCREEN_INPUT_TICK', array(
        'VALUE' => 'EU',
        'CHECKED' => true,
        'TABINDEX' => strval($tabindex),
        'NAME' => $set_name . '_eu',
        'READ_ONLY' => true,
        'DISABLED' => false,
    ));
    $field_set->attach(_form_input($set_name . '_eu', do_lang_tempcode('TAX_EU'), do_lang_tempcode('DESCRIPTION_TAX_EU'), $input, $required, false, $tabindex));

    // TaxCloud input...

    if ((get_option('taxcloud_api_key') != '') && (get_option('taxcloud_api_id') != '')) {
        require_code('files2');
        list($__tics) = cache_and_carry('http_download_file', array('https://taxcloud.net/tic/?format=json'));
        $_tics = json_decode($__tics, true); // TODO: Fix in v11
        $tics = new Tempcode();
        $tics->attach(_prepare_tics_list($_tics['tic_list'], $default, 'root'));
        $tics->attach(_prepare_tics_list($_tics['tic_list'], $default, ''));
        require_css('widget_select2');
        require_javascript('jquery');
        require_javascript('select2');
        $input = do_template('FORM_SCREEN_INPUT_LIST', array(
            'TABINDEX' => strval($tabindex),
            'REQUIRED' => $_required,
            'NAME' => $set_name . '_tic',
            'CONTENT' => $tics,
            'INLINE_LIST' => false,
            'SIZE' => strval(5),
        ));
        $field_set->attach(_form_input($set_name . '_tic', do_lang_tempcode('TAX_TIC'), do_lang_tempcode('DESCRIPTION_TAX_TIC'), $input, $required, false, $tabindex));
    }

    // --

    $fields->attach(alternate_fields_set__end($set_name, $set_title, '', $field_set, $required));
    return $fields;
}

/**
 * Get a hierarchical TIC selection list.
 *
 * @param  array $all_tics The list of TICs
 * @param  string $default Default value
 * @param  string $parent Only get child nodes of
 * @param  string $pre Prefix for parent chain
 * @return Tempcode The list
 */
function _prepare_tics_list($all_tics, $default, $parent, $pre = '')
{
    $child_tics = array();
    foreach ($all_tics as $i => $_tic) {
        $tic = $_tic['tic'];
        if ($tic['parent'] == $parent) {
            $child_tics[] = $tic;
        }

        if (isset($tic['children'])) {
            foreach ($tic['children'] as $_tic) {
                $all_tics[] = $_tic;
            }
            unset($all_tics[$i]['tic']['children']);
        }
    }
    sort_maps_by($child_tics, 'label');

    $tics_list = new Tempcode();
    foreach ($child_tics as $tic) {
        $text = $pre . html_entity_decode($tic['label'], ENT_QUOTES, get_charset());
        $title = html_entity_decode($tic['title'], ENT_QUOTES, get_charset());
        $tics_list->attach(form_input_list_entry('TIC:' . $tic['id'], $tic['id'] == $default, $text, false, false, $title));

        $under = _prepare_tics_list($all_tics, $default, $tic['id'], $text . ' > ');
        $tics_list->attach($under);
    }

    return $tics_list;
}

/**
 * Read a tax value from the POST environment.
 *
 * @param  string $name Variable name
 * @param  string $default Default value
 * @return string The value
 */
function post_param_tax($name, $default = '')
{
    $value = post_param_string($name . '_float', ''); // Simple rate
    if ($value == '') {
        $value = post_param_string($name . '_eu', ''); // EU rate
        if ($value == '') {
            $value = post_param_string($name . '_tic', ''); // TaxCloud
            if ($value == '') {
                $value = $default; // Default
            }
        }
    }
    return $value;
}
