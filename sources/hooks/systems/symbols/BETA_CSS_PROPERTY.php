<?php /*

 Composr
 Copyright (c) ocProducts, 2004-2016

 See text/EN/licence.txt for full licencing information.


 NOTE TO PROGRAMMERS:
   Do not edit this file. If you need to make changes, save your changed file to the appropriate *_custom folder
   **** If you ignore this advice, then your website upgrades (e.g. for bug fixes) will likely kill your changes ****

*/

/**
 * @license    http://opensource.org/licenses/cpal_1.0 Common Public Attribution License
 * @copyright  ocProducts Ltd
 * @package    core
 */

/**
 * Hook class.
 */
class Hook_symbol_BETA_CSS_PROPERTY
{
    /**
     * Run function for symbol hooks. Searches for tasks to perform.
     *
     * @param  array $param Symbol parameters
     * @return string Result
     */
    public function run($param)
    {
        /*
        Properties currently used:
         backface-visibility
         flex-wrap
         user-select

        Property settings currently used:
         background-image
          linear-gradient
         display
          flex
        */

        $value = '';

        if (isset($param[0])) {
            // No prefixing needed for these
            $is_supported = array(
                '-o-' => array(
                    'backface-visibility',
                ),
                '-webkit-' => array(
                    'backface-visibility',
                ),
                '-ms-' => array(
                ),
                '-moz-' => array(
                    'backface-visibility',
                ),
            );

            $value = '';
            $matches = array();

            $vendors = array('', '-o-', '-webkit-', '-ms-', '-moz-');
            foreach ($vendors as $prefix) {
                // Skip over some
                if ((strpos($param[0], ':') !== false) && (isset($is_supported[$prefix][substr($param[0], 0, strpos($param[0], ':'))]))) {
                    continue;
                }

                // Normalise
                if (substr(trim($param[0]), -1) != ';') {
                    $value .= '; ';
                }

                // CSS gradients aren't a new property as such, they're a prefixed extension to an existing one
                if (preg_match('#^background-image:\s*(\w+-gradient)(.*)$#s', $param[0], $matches) != 0) {
                    $new_style = $matches[2];
                    $old_style = str_replace(array('to right', 'to bottom', 'to bottom right', 'to top right'), array('left', 'top', 'top left', 'bottom left'), $new_style); // This is because the spec changed; at time of writing only MS support the new spec, so for others we'll need to put out both methods (as they'll likely break their self-compatibility)
                    if (($prefix != '-ms-') && ($prefix != '')) {
                        $value .= 'background-image: ' . $prefix . $matches[1] . $old_style;
                    }
                    $value .= 'background-image: ' . $prefix . $matches[1] . $new_style;
                    $value .= "\n\t";
                    continue;
                }

                // Flexbox is a prefixed extension to an existing one
                if (preg_match('#^display:\s*flex(.*)$#s', $param[0], $matches) != 0) {
                    if ($prefix == '-ms-') {
                        // For IE10 we need an additional option
                        $value .= 'display: -ms-flexbox;';
                        $value .= "\n\t";
                    }

                    $value .= 'display: ' . $prefix . 'flex;';
                    $value .= "\n\t";
                    continue;
                }

                // Most cases
                $value .= $prefix . $param[0];
                $value .= "\n\t";
            }
            $value = rtrim($value);
        }

        return $value;
    }
}
